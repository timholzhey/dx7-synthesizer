<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FM Synthesizer</title>
</head>
<body>
    <h1>FM Synthesizer</h1>
    <canvas id="viz" width="200" height="100"></canvas>
    <div id="rom-selection">
        <select id="roms"></select>
        <button id="load-rom">Load ROM</button>
    </div>
    <div id="patch-selection">
        <select id="patches"></select>
        <button id="load-patch">Load Patch</button>
    </div>
    <button id="toggle-voice">Toggle Voice (Middle C)</button>
    <div id="voice-params" style="white-space: pre;"></div>
    <script>
        // Rom selection
        const roms = document.getElementById("roms");
        const load_rom = document.getElementById("load-rom");
        fetch(`http://${window.location.host}/api/get_roms`)
            .then(response => response.json())
            .then(data => {
                for (const rom of data.roms) {
                    const option = document.createElement("option");
                    option.value = rom;
                    option.text = rom;
                    roms.appendChild(option);
                }
                if (data.is_loaded) {
                    roms.value = data.current_rom;
                }
            });
        load_rom.onclick = function(event) {
            event.preventDefault();
            const rom = roms.value;
            const body = JSON.stringify({rom: rom});
            fetch(`http://${window.location.host}/api/select_rom`, {
                method: "POST",
                body: body
            });
        }

        // Patch selection
        const patches = document.getElementById("patches");
        const load_patch = document.getElementById("load-patch");
        fetch(`http://${window.location.host}/api/get_patches`)
            .then(response => response.json())
            .then(data => {
                for (const patch of data.patches) {
                    const option = document.createElement("option");
                    option.value = patch;
                    option.text = patch;
                    patches.appendChild(option);
                }
                if (data.is_loaded) {
                    patches.value = data.current_patch;
                }
            });
        load_patch.onclick = function(event) {
            event.preventDefault();
            const patch = patches.value;
            const body = JSON.stringify({patch: patch});
            fetch(`http://${window.location.host}/api/select_patch`, {
                method: "POST",
                body: body
            }).then(loadParams);
        }

        // Voice params
        loadParams = function() {
            const voice_params = document.getElementById("voice-params");
            fetch(`http://${window.location.host}/api/get_params`)
                .then(response => response.json())
                .then(data => {
                    voice_params.innerHTML = JSON.stringify(data.params, null, 2);
                });
        };
        loadParams();

        // Visualization
        fetch(`http://${window.location.host}/api/viz_stream`)
            .then(async (response) => {
                const reader = response.body.getReader();
                for await (const chunk of readChunks(reader)) {
                    const samples = new Int32Array(chunk.buffer);
                    let max = 0;
                    for (let i = 0; i < samples.length; i++) {
                        const sample = samples[i] / 32768;
                        samples[i] = sample;
                        if (Math.abs(sample) > max) {
                            max = Math.abs(sample);
                        }
                    }
                    const canvas = document.getElementById("viz");
                    const ctx = canvas.getContext("2d");
                    const width = canvas.width;
                    const height = canvas.height;
                    const xStep = width / samples.length;
                    const yStep = height / 2 / max;
                    ctx.clearRect(0, 0, width, height);
                    ctx.beginPath();
                    ctx.moveTo(0, height / 2);
                    for (let i = 0; i < samples.length; i++) {
                        ctx.lineTo(i * xStep, height / 2 + samples[i] * yStep);
                    }
                    ctx.stroke();
                }
            })

        function readChunks(reader) {
            return {
                async* [Symbol.asyncIterator]() {
                    let readResult = await reader.read();
                    while (!readResult.done) {
                        yield readResult.value;
                        readResult = await reader.read();
                    }
                },
            };
        }

        // Toggle voice
        const toggle_voice = document.getElementById("toggle-voice");
        is_voice_on = false;
        // websocket on /api/midi, send note on note off midi messages as binary data, 3 bytes
        const ws_midi = new WebSocket(`ws://${window.location.host}/api/midi`);
        toggle_voice.onclick = function(event) {
            event.preventDefault();
            if (is_voice_on) {
                ws_midi.send(new Uint8Array([0x80, 0x3c, 0x40]));
            } else {
                ws_midi.send(new Uint8Array([0x90, 0x3c, 0x40]));
            }
            is_voice_on = !is_voice_on;
        };
    </script>
</body>
</html>